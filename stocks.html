<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Scoring Dashboard</title>
  <meta name="robots" content="noindex, nofollow">

  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%236C5CE7'/><text x='50' y='68' font-family='Arial' font-size='55' font-weight='bold' fill='white' text-anchor='middle'>G</text></svg>">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0A0A0B;
      --surface: #141416;
      --surface-elevated: #1C1C1F;
      --accent: #6C5CE7;
      --accent-light: #A29BFE;
      --accent-glow: rgba(108, 92, 231, 0.15);
      --text: #F5F5F7;
      --text-secondary: #8E8E93;
      --text-tertiary: #636366;
      --success: #34C759;
      --warning: #FF9F43;
      --danger: #EA4335;
      --border: rgba(255, 255, 255, 0.06);
      --border-accent: rgba(108, 92, 231, 0.3);
      --radius: 16px;
      --radius-sm: 10px;
      --radius-xs: 8px;
      --transition: 0.2s ease;
    }

    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
    }

    .dashboard {
      max-width: 1360px;
      margin: 0 auto;
      padding: 40px 24px 60px;
    }

    /* ========== HEADER ========== */
    .dash-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .dash-header h1 {
      font-size: 2.4rem;
      font-weight: 800;
      letter-spacing: -0.03em;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--text) 0%, var(--accent-light) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .dash-header .subtitle {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .api-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 16px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 100px;
      font-size: 0.78rem;
      color: var(--text-secondary);
    }

    .api-badge .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--warning);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* ========== STATS BAR ========== */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px 24px;
      text-align: center;
    }

    .stat-card .stat-label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-tertiary);
      margin-bottom: 6px;
    }

    .stat-card .stat-value {
      font-size: 1.7rem;
      font-weight: 700;
      color: var(--text);
    }

    .stat-card .stat-value.accent {
      color: var(--accent-light);
    }

    .stat-card .stat-value.success {
      color: var(--success);
    }

    /* ========== TOOLBAR ========== */
    .toolbar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .toolbar input,
    .toolbar select {
      font-family: 'Inter', sans-serif;
      font-size: 0.88rem;
      padding: 10px 16px;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: var(--radius-xs);
      outline: none;
      transition: border-color var(--transition);
    }

    .toolbar input:focus,
    .toolbar select:focus {
      border-color: var(--accent);
    }

    .toolbar input {
      flex: 1;
      min-width: 220px;
    }

    .toolbar select {
      min-width: 160px;
      cursor: pointer;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238E8E93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
    }

    .toolbar select option {
      background: var(--surface);
      color: var(--text);
    }

    /* ========== TABLE ========== */
    .table-wrapper {
      overflow-x: auto;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface);
    }

    .stocks-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 880px;
    }

    .stocks-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .stocks-table th {
      padding: 14px 16px;
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-tertiary);
      background: var(--surface-elevated);
      border-bottom: 1px solid var(--border);
      text-align: left;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      transition: color var(--transition);
      position: relative;
    }

    .stocks-table th:hover {
      color: var(--text-secondary);
    }

    .stocks-table th.sort-active {
      color: var(--accent-light);
    }

    .stocks-table th .sort-arrow {
      margin-left: 4px;
      font-size: 0.65rem;
      opacity: 0;
      transition: opacity var(--transition);
    }

    .stocks-table th:hover .sort-arrow,
    .stocks-table th.sort-active .sort-arrow {
      opacity: 1;
    }

    .stocks-table th.text-right,
    .stocks-table td.text-right {
      text-align: right;
    }

    .stocks-table th.text-center,
    .stocks-table td.text-center {
      text-align: center;
    }

    .stocks-table td {
      padding: 12px 16px;
      font-size: 0.88rem;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      transition: background var(--transition);
    }

    .stocks-table tbody tr:hover td {
      background: rgba(255, 255, 255, 0.02);
    }

    .stocks-table tbody tr:last-child td {
      border-bottom: none;
    }

    /* Column styles */
    .col-rank {
      font-weight: 600;
      color: var(--text-tertiary);
      width: 50px;
    }

    .col-ticker {
      font-weight: 700;
      color: var(--accent-light);
      letter-spacing: 0.02em;
    }

    .col-company {
      font-weight: 500;
      color: var(--text);
    }

    .col-mcap {
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }

    .col-peg,
    .col-fcf,
    .col-div {
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    /* Sector pills */
    .sector-pill {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 100px;
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
    }

    .sector-Technology { background: rgba(108, 92, 231, 0.12); color: #A29BFE; }
    .sector-Healthcare { background: rgba(52, 199, 89, 0.12); color: #34C759; }
    .sector-Financials { background: rgba(0, 122, 255, 0.12); color: #5AC8FA; }
    .sector-Consumer-Discretionary { background: rgba(255, 159, 67, 0.12); color: #FF9F43; }
    .sector-Communication-Services { background: rgba(225, 123, 251, 0.12); color: #e17bfb; }
    .sector-Consumer-Staples { background: rgba(90, 200, 250, 0.12); color: #5AC8FA; }
    .sector-Energy { background: rgba(255, 204, 0, 0.12); color: #FFCC00; }
    .sector-Industrials { background: rgba(142, 142, 147, 0.12); color: #8E8E93; }
    .sector-Materials { background: rgba(162, 132, 94, 0.12); color: #C4A265; }
    .sector-Utilities { background: rgba(48, 209, 88, 0.12); color: #30D158; }
    .sector-Real-Estate { background: rgba(175, 82, 222, 0.12); color: #AF52DE; }

    /* Score cell */
    .score-cell {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 80px;
    }

    .score-number {
      font-weight: 700;
      font-size: 0.95rem;
      font-variant-numeric: tabular-nums;
    }

    .score-bar {
      width: 100%;
      height: 4px;
      background: var(--surface-elevated);
      border-radius: 2px;
      overflow: hidden;
    }

    .score-bar-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.4s ease;
    }

    /* ========== EMPTY STATE ========== */
    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-secondary);
    }

    .empty-state h3 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .empty-state p {
      font-size: 0.88rem;
      margin-bottom: 20px;
    }

    .btn-clear {
      display: inline-block;
      padding: 8px 20px;
      font-family: 'Inter', sans-serif;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--accent-light);
      background: transparent;
      border: 1px solid var(--border-accent);
      border-radius: var(--radius-xs);
      cursor: pointer;
      transition: all var(--transition);
    }

    .btn-clear:hover {
      background: var(--accent-glow);
    }

    /* ========== FOOTER ========== */
    .dash-footer {
      text-align: center;
      padding: 40px 0 0;
      color: var(--text-tertiary);
      font-size: 0.8rem;
      line-height: 1.8;
    }

    /* ========== LOADING ========== */
    .loading-overlay {
      text-align: center;
      padding: 80px 24px;
      color: var(--text-secondary);
    }

    .loading-overlay .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-overlay p {
      font-size: 0.9rem;
    }

    .loading-overlay .progress-text {
      font-size: 0.78rem;
      color: var(--text-tertiary);
      margin-top: 8px;
    }

    .status-live .dot { background: var(--success) !important; }
    .status-error .dot { background: var(--danger) !important; }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
      .dashboard {
        padding: 24px 16px 40px;
      }

      .dash-header h1 {
        font-size: 1.7rem;
      }

      .stats-bar {
        grid-template-columns: repeat(2, 1fr);
      }

      .toolbar {
        flex-direction: column;
      }

      .toolbar input,
      .toolbar select {
        min-width: 100%;
      }
    }

    @media (max-width: 480px) {
      .dash-header h1 {
        font-size: 1.4rem;
      }

      .stats-bar {
        grid-template-columns: 1fr;
      }

      .stat-card .stat-value {
        font-size: 1.4rem;
      }
    }
  </style>
</head>
<body>

  <div class="dashboard">

    <!-- Header -->
    <header class="dash-header">
      <h1>Stock Scoring Dashboard</h1>
      <p class="subtitle">Fundamental analysis scoring for large-cap equities</p>
      <div class="api-badge" id="api-badge">
        <span class="dot" id="status-dot"></span>
        <span id="status-text">Loading live data...</span>
      </div>
    </header>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-label">Total Stocks</div>
        <div class="stat-value" id="stat-total">--</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Average Score</div>
        <div class="stat-value accent" id="stat-avg">--</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Top Scorer</div>
        <div class="stat-value success" id="stat-top">--</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Last Updated</div>
        <div class="stat-value" id="stat-date">--</div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <input type="text" id="search" placeholder="Search by ticker or company..." aria-label="Search stocks by ticker or company name">
      <select id="filter-sector" aria-label="Filter by sector">
        <option value="">All Sectors</option>
        <option>Technology</option>
        <option>Healthcare</option>
        <option>Financials</option>
        <option>Consumer Discretionary</option>
        <option>Communication Services</option>
        <option>Consumer Staples</option>
        <option>Energy</option>
        <option>Industrials</option>
      </select>
      <select id="filter-score" aria-label="Filter by score range">
        <option value="">All Scores</option>
        <option value="80-100">80-100 Excellent</option>
        <option value="60-79">60-79 Good</option>
        <option value="40-59">40-59 Fair</option>
        <option value="0-39">0-39 Poor</option>
      </select>
    </div>

    <!-- Loading -->
    <div class="loading-overlay" id="loading">
      <div class="spinner"></div>
      <p>Fetching live market data...</p>
      <p class="progress-text" id="loading-progress">Connecting to API...</p>
    </div>

    <!-- Table -->
    <div class="table-wrapper" style="display:none;">
      <table class="stocks-table" role="grid">
        <thead>
          <tr>
            <th class="text-center" data-sort="rank"># <span class="sort-arrow"></span></th>
            <th data-sort="ticker">Ticker <span class="sort-arrow"></span></th>
            <th data-sort="company">Company <span class="sort-arrow"></span></th>
            <th data-sort="sector">Sector <span class="sort-arrow"></span></th>
            <th class="text-right" data-sort="marketCap">Market Cap <span class="sort-arrow"></span></th>
            <th class="text-right" data-sort="peg">PEG Ratio <span class="sort-arrow"></span></th>
            <th class="text-right" data-sort="fcfYield">FCF Yield <span class="sort-arrow"></span></th>
            <th class="text-right" data-sort="divYield">Div Yield <span class="sort-arrow"></span></th>
            <th class="text-right" data-sort="score">Score <span class="sort-arrow"></span></th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div class="empty-state" id="empty-state" style="display:none;">
      <h3>No stocks match your filters</h3>
      <p>Try adjusting your search or filter criteria</p>
      <button class="btn-clear" id="btn-clear-filters">Clear Filters</button>
    </div>

    <!-- Footer -->
    <footer class="dash-footer">
      <p>Data powered by Financial Modeling Prep. Scores are algorithmically calculated.</p>
      <p>Built for personal use. Not financial advice.</p>
    </footer>

  </div>

<script>
'use strict';

// ============================================================
// CONFIG
// ============================================================
const API_KEY = 'CFywTxjgPsYUjXyU7ev2lxPdFCN0zKEf';
const BASE_URL = 'https://financialmodelingprep.com/stable';

// Large-cap tickers to track
const TICKERS = [
  'AAPL','MSFT','NVDA','GOOGL','AMZN','META','TSM','AVGO','BRK-B','LLY',
  'JPM','V','WMT','MA','UNH','XOM','COST','HD','PG','JNJ',
  'ABBV','CRM','NFLX','AMD','ORCL','ADBE','DIS','INTC','PFE','KO',
  'PEP','BAC','CVX','CSCO','T'
];

// Sector mapping (FMP uses different names sometimes)
const SECTOR_MAP = {
  'Technology': 'Technology',
  'Communication Services': 'Communication Services',
  'Consumer Cyclical': 'Consumer Discretionary',
  'Consumer Defensive': 'Consumer Staples',
  'Financial Services': 'Financials',
  'Healthcare': 'Healthcare',
  'Energy': 'Energy',
  'Industrials': 'Industrials',
  'Basic Materials': 'Materials',
  'Utilities': 'Utilities',
  'Real Estate': 'Real Estate',
};

// ============================================================
// FALLBACK PLACEHOLDER DATA (used when API + cache unavailable)
// ============================================================
const PLACEHOLDER_STOCKS = [
  { ticker: "NVDA",  company: "NVIDIA Corporation",        sector: "Technology",              marketCap: 4621.5, peg: 3.17, fcfYield: 2.41, divYield: 0.02, score: 43 },
  { ticker: "META",  company: "Meta Platforms Inc.",        sector: "Communication Services",  marketCap: 1580.0, peg: 1.15, fcfYield: 4.12, divYield: 0.35, score: 61 },
  { ticker: "AMD",   company: "Advanced Micro Devices",    sector: "Technology",              marketCap: 280.0,  peg: 1.18, fcfYield: 3.85, divYield: 0.00, score: 46 },
  { ticker: "TSM",   company: "Taiwan Semiconductor",      sector: "Technology",              marketCap: 920.0,  peg: 1.32, fcfYield: 3.10, divYield: 1.20, score: 54 },
  { ticker: "GOOGL", company: "Alphabet Inc.",             sector: "Communication Services",  marketCap: 2140.0, peg: 1.08, fcfYield: 5.20, divYield: 0.45, score: 65 },
  { ticker: "NFLX",  company: "Netflix Inc.",              sector: "Communication Services",  marketCap: 340.0,  peg: 1.42, fcfYield: 4.50, divYield: 0.00, score: 52 },
  { ticker: "AAPL",  company: "Apple Inc.",                sector: "Technology",              marketCap: 3888.8, peg: 5.63, fcfYield: 3.13, divYield: 0.38, score: 41 },
  { ticker: "MSFT",  company: "Microsoft Corporation",     sector: "Technology",              marketCap: 3180.0, peg: 2.12, fcfYield: 3.45, divYield: 0.72, score: 50 },
  { ticker: "AMZN",  company: "Amazon.com Inc.",           sector: "Consumer Discretionary",  marketCap: 2080.0, peg: 1.92, fcfYield: 2.80, divYield: 0.00, score: 44 },
  { ticker: "AVGO",  company: "Broadcom Inc.",             sector: "Technology",              marketCap: 830.0,  peg: 1.78, fcfYield: 3.90, divYield: 1.15, score: 57 },
  { ticker: "JPM",   company: "JPMorgan Chase & Co.",      sector: "Financials",              marketCap: 680.0,  peg: 1.22, fcfYield: 8.50, divYield: 2.10, score: 74 },
  { ticker: "ABBV",  company: "AbbVie Inc.",               sector: "Healthcare",              marketCap: 340.0,  peg: 1.68, fcfYield: 6.20, divYield: 3.40, score: 72 },
  { ticker: "UNH",   company: "UnitedHealth Group Inc.",   sector: "Healthcare",              marketCap: 520.0,  peg: 1.55, fcfYield: 4.80, divYield: 1.50, score: 62 },
  { ticker: "BAC",   company: "Bank of America Corp.",     sector: "Financials",              marketCap: 340.0,  peg: 1.38, fcfYield: 9.10, divYield: 2.40, score: 75 },
  { ticker: "CRM",   company: "Salesforce Inc.",           sector: "Technology",              marketCap: 310.0,  peg: 1.95, fcfYield: 5.10, divYield: 0.50, score: 53 },
  { ticker: "V",     company: "Visa Inc.",                 sector: "Financials",              marketCap: 620.0,  peg: 2.35, fcfYield: 4.20, divYield: 0.75, score: 52 },
  { ticker: "MA",    company: "Mastercard Inc.",           sector: "Financials",              marketCap: 480.0,  peg: 2.41, fcfYield: 3.80, divYield: 0.55, score: 48 },
  { ticker: "ADBE",  company: "Adobe Inc.",                sector: "Technology",              marketCap: 240.0,  peg: 1.88, fcfYield: 5.50, divYield: 0.00, score: 50 },
  { ticker: "BRK.B", company: "Berkshire Hathaway Inc.",   sector: "Financials",              marketCap: 1050.0, peg: 1.45, fcfYield: 7.20, divYield: 0.00, score: 57 },
  { ticker: "ORCL",  company: "Oracle Corporation",        sector: "Technology",              marketCap: 390.0,  peg: 2.22, fcfYield: 4.60, divYield: 1.00, score: 54 },
  { ticker: "HD",    company: "The Home Depot Inc.",       sector: "Consumer Discretionary",  marketCap: 390.0,  peg: 2.05, fcfYield: 5.30, divYield: 2.30, score: 59 },
  { ticker: "JNJ",   company: "Johnson & Johnson",        sector: "Healthcare",              marketCap: 370.0,  peg: 2.15, fcfYield: 6.80, divYield: 3.10, score: 66 },
  { ticker: "WMT",   company: "Walmart Inc.",              sector: "Consumer Staples",        marketCap: 590.0,  peg: 2.88, fcfYield: 3.20, divYield: 1.10, score: 44 },
  { ticker: "CSCO",  company: "Cisco Systems Inc.",        sector: "Technology",              marketCap: 240.0,  peg: 2.30, fcfYield: 6.50, divYield: 2.80, score: 62 },
  { ticker: "LLY",   company: "Eli Lilly and Company",    sector: "Healthcare",              marketCap: 780.0,  peg: 3.85, fcfYield: 1.80, divYield: 0.65, score: 35 },
  { ticker: "PG",    company: "Procter & Gamble Co.",      sector: "Consumer Staples",        marketCap: 380.0,  peg: 2.78, fcfYield: 5.40, divYield: 2.40, score: 56 },
  { ticker: "KO",    company: "The Coca-Cola Company",    sector: "Consumer Staples",        marketCap: 270.0,  peg: 2.65, fcfYield: 4.90, divYield: 2.90, score: 57 },
  { ticker: "PEP",   company: "PepsiCo Inc.",              sector: "Consumer Staples",        marketCap: 230.0,  peg: 2.72, fcfYield: 5.10, divYield: 3.20, score: 58 },
  { ticker: "XOM",   company: "Exxon Mobil Corporation",  sector: "Energy",                  marketCap: 470.0,  peg: 1.82, fcfYield: 7.80, divYield: 3.50, score: 72 },
  { ticker: "DIS",   company: "The Walt Disney Company",  sector: "Communication Services",  marketCap: 210.0,  peg: 2.45, fcfYield: 3.40, divYield: 0.90, score: 42 },
  { ticker: "CVX",   company: "Chevron Corporation",      sector: "Energy",                  marketCap: 290.0,  peg: 2.10, fcfYield: 8.20, divYield: 4.10, score: 73 },
  { ticker: "COST",  company: "Costco Wholesale Corp.",   sector: "Consumer Staples",        marketCap: 410.0,  peg: 3.12, fcfYield: 2.50, divYield: 0.50, score: 36 },
  { ticker: "PFE",   company: "Pfizer Inc.",               sector: "Healthcare",              marketCap: 160.0,  peg: 3.20, fcfYield: 9.50, divYield: 5.80, score: 65 },
  { ticker: "T",     company: "AT&T Inc.",                 sector: "Communication Services",  marketCap: 160.0,  peg: 3.80, fcfYield: 10.20, divYield: 4.80, score: 62 },
  { ticker: "INTC",  company: "Intel Corporation",        sector: "Technology",              marketCap: 120.0,  peg: 4.50, fcfYield: null, divYield: 0.00, score: 11 },
];

// ============================================================
// STATE
// ============================================================
let STOCKS = [];
let sortColumn = 'peg';
let sortDirection = 'asc';

// ============================================================
// API FETCHING
// ============================================================
function setProgress(text) {
  const el = document.getElementById('loading-progress');
  if (el) el.textContent = text;
}

function setStatus(type, text) {
  const badge = document.getElementById('api-badge');
  const statusText = document.getElementById('status-text');
  badge.className = 'api-badge status-' + type;
  statusText.textContent = text;
}

const CACHE_KEY = 'stocks_dashboard_cache';

async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error('API error: ' + res.status);
  const json = await res.json();
  // FMP returns error messages as objects sometimes
  if (json && json['Error Message']) throw new Error(json['Error Message']);
  return json;
}

// ============================================================
// CACHE
// ============================================================
function saveCache(stocks) {
  try {
    const cache = {
      timestamp: Date.now(),
      date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
      stocks
    };
    localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
  } catch (e) { console.warn('Cache save failed', e); }
}

function loadCache() {
  try {
    const raw = localStorage.getItem(CACHE_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch (e) { return null; }
}

function showCachedData(cache) {
  STOCKS = cache.stocks;
  document.getElementById('loading').style.display = 'none';
  setStatus('live', 'Cached data \u2014 ' + cache.date);
  renderTable();
}

// ============================================================
// FETCH
// ============================================================
async function fetchAllData() {
  // Try loading cache first for instant display
  const cache = loadCache();
  if (cache && cache.stocks && cache.stocks.length > 0) {
    showCachedData(cache);
    setProgress('Showing cached data. Refreshing...');
  }

  try {
    const total = TICKERS.length;
    const quoteMap = {};
    const ratiosMap = {};
    const metricsMap = {};

    // Step 1: Fetch profiles individually (has sector, avgVolume, marketCap)
    for (let i = 0; i < total; i++) {
      const t = TICKERS[i];
      setProgress('Fetching profiles (' + (i + 1) + '/' + total + ') \u2014 ' + t + '...');
      try {
        const data = await fetchJSON(`${BASE_URL}/profile?symbol=${t}&apikey=${API_KEY}`);
        if (data && data.length > 0) quoteMap[t] = data[0];
      } catch (e) { console.warn('Profile failed for', t, e); }
    }

    if (Object.keys(quoteMap).length === 0) {
      if (cache && cache.stocks && cache.stocks.length > 0) {
        // API failed but we have cache — just keep showing it
        setStatus('live', 'Cached data \u2014 ' + cache.date + ' (API limit reached)');
        return;
      }
      throw new Error('No data returned. API limit may be reached.');
    }

    // Step 2: Fetch ratios TTM (has PEG ratio) + key metrics (has ROE)
    for (let i = 0; i < total; i++) {
      const t = TICKERS[i];
      setProgress('Fetching fundamentals (' + (i + 1) + '/' + total + ') \u2014 ' + t + '...');
      try {
        const [ratios, metrics] = await Promise.all([
          fetchJSON(`${BASE_URL}/ratios-ttm?symbol=${t}&apikey=${API_KEY}`).catch(() => []),
          fetchJSON(`${BASE_URL}/key-metrics-ttm?symbol=${t}&apikey=${API_KEY}`).catch(() => [])
        ]);
        if (ratios && ratios.length > 0) ratiosMap[t] = ratios[0];
        if (metrics && metrics.length > 0) metricsMap[t] = metrics[0];
      } catch (e) { console.warn('Fundamentals failed for', t, e); }
    }

    // Step 3: Combine everything
    setProgress('Calculating scores...');
    STOCKS = TICKERS.map(t => {
      const displayTicker = t === 'BRK-B' ? 'BRK.B' : t;
      const q = quoteMap[t] || {};
      const r = ratiosMap[t] || {};
      const m = metricsMap[t] || {};

      const rawSector = q.sector || 'Unknown';
      const sector = SECTOR_MAP[rawSector] || rawSector;
      const marketCapB = (q.marketCap || q.mktCap || 0) / 1e9;
      const peg = r.priceToEarningsGrowthRatioTTM || null;

      // FCF Yield = 1 / Price-to-FCF ratio (as percentage)
      const p2fcf = r.priceToFreeCashFlowRatioTTM || null;
      const fcfYield = (p2fcf !== null && p2fcf > 0) ? (1 / p2fcf) * 100 : null;

      // Dividend Yield (already a decimal from API, convert to %)
      const rawDivYield = r.dividendYieldTTM || null;
      const divYield = (rawDivYield !== null && rawDivYield >= 0) ? rawDivYield * 100 : null;

      // Calculate score
      const score = calculateScore(peg, fcfYield, divYield, marketCapB, m);

      return {
        ticker: displayTicker,
        company: q.companyName || q.name || t,
        sector,
        marketCap: Math.round(marketCapB * 10) / 10,
        peg: (peg !== null && peg > 0 && peg < 100) ? Math.round(peg * 100) / 100 : null,
        fcfYield: fcfYield !== null ? Math.round(fcfYield * 100) / 100 : null,
        divYield: divYield !== null ? Math.round(divYield * 100) / 100 : null,
        score
      };
    }).filter(s => s.marketCap > 0);

    // Save to cache
    saveCache(STOCKS);

    // Done!
    document.getElementById('loading').style.display = 'none';
    setStatus('live', 'Live data \u2014 ' + new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }));
    renderTable();

  } catch (err) {
    console.error('Fetch error:', err);
    if (!cache || !cache.stocks || cache.stocks.length === 0) {
      // No cache — show placeholder data
      STOCKS = PLACEHOLDER_STOCKS;
      document.getElementById('loading').style.display = 'none';
      setStatus('error', 'Placeholder data \u2014 API limit reached');
      renderTable();
    } else {
      // Cache is already showing, just update the status
      setStatus('live', 'Cached data \u2014 ' + cache.date + ' (API limit reached)');
    }
  }
}

// ============================================================
// SCORING ALGORITHM (0-100)
// ============================================================
function calculateScore(peg, fcfYield, divYield, marketCapB, metrics) {
  let score = 0;

  // --- PEG Ratio (0-35 points) ---
  // Lower PEG = better value. Ideal: < 1.0
  if (peg !== null && peg > 0 && peg < 50) {
    if (peg <= 0.5) score += 35;
    else if (peg <= 1.0) score += 30;
    else if (peg <= 1.5) score += 25;
    else if (peg <= 2.0) score += 18;
    else if (peg <= 3.0) score += 10;
    else score += 3;
  }

  // --- FCF Yield (0-25 points) ---
  // Higher FCF yield = more cash returned per dollar invested
  if (fcfYield !== null) {
    if (fcfYield >= 8) score += 25;
    else if (fcfYield >= 6) score += 20;
    else if (fcfYield >= 4) score += 15;
    else if (fcfYield >= 2) score += 10;
    else if (fcfYield >= 0) score += 4;
    else score += 0;
  }

  // --- Dividend Yield (0-15 points) ---
  // Reward dividends but don't over-penalize growth stocks
  if (divYield !== null) {
    if (divYield >= 4) score += 15;
    else if (divYield >= 3) score += 12;
    else if (divYield >= 2) score += 9;
    else if (divYield >= 1) score += 6;
    else if (divYield > 0) score += 3;
    else score += 0;
  }

  // --- Market Cap / Stability (0-10 points) ---
  if (marketCapB >= 1000) score += 10;
  else if (marketCapB >= 500) score += 8;
  else if (marketCapB >= 200) score += 6;
  else if (marketCapB >= 100) score += 4;
  else score += 2;

  // --- Profitability / ROE (0-15 points) ---
  const roe = metrics.returnOnEquityTTM || metrics.roeTTM || null;
  if (roe !== null) {
    if (roe >= 0.30) score += 15;
    else if (roe >= 0.20) score += 12;
    else if (roe >= 0.15) score += 9;
    else if (roe >= 0.10) score += 6;
    else if (roe >= 0) score += 3;
    else score += 0;
  } else {
    score += 5;
  }

  return Math.min(100, Math.max(0, Math.round(score)));
}

// ============================================================
// UTILITIES
// ============================================================
function getScoreColor(score) {
  if (score >= 80) return 'var(--success)';
  if (score >= 60) return 'var(--accent-light)';
  if (score >= 40) return 'var(--warning)';
  return 'var(--danger)';
}

function getPEGColor(peg) {
  if (peg === null) return 'var(--text-tertiary)';
  if (peg < 1.0) return 'var(--success)';
  if (peg <= 2.0) return 'var(--text)';
  if (peg <= 3.0) return 'var(--warning)';
  return 'var(--danger)';
}

function formatPercent(val) {
  if (val === null) return 'N/A';
  return val.toFixed(2) + '%';
}

function getFCFColor(fcf) {
  if (fcf === null) return 'var(--text-tertiary)';
  if (fcf >= 6) return 'var(--success)';
  if (fcf >= 3) return 'var(--text)';
  if (fcf >= 0) return 'var(--warning)';
  return 'var(--danger)';
}

function getDivColor(div) {
  if (div === null) return 'var(--text-tertiary)';
  if (div >= 3) return 'var(--success)';
  if (div >= 1) return 'var(--text)';
  if (div > 0) return 'var(--text-secondary)';
  return 'var(--text-tertiary)';
}

function formatMarketCap(b) {
  if (b >= 1000) return '$' + (b / 1000).toFixed(2) + 'T';
  if (b >= 100) return '$' + Math.round(b) + 'B';
  return '$' + b.toFixed(1) + 'B';
}

function formatPEG(peg) {
  if (peg === null) return 'N/A';
  return peg.toFixed(2);
}

function sectorClass(sector) {
  return 'sector-' + sector.replace(/\s+/g, '-');
}

// ============================================================
// FILTERING
// ============================================================
function getFilteredData() {
  const query = document.getElementById('search').value.toLowerCase().trim();
  const sectorFilter = document.getElementById('filter-sector').value;
  const scoreFilter = document.getElementById('filter-score').value;

  return STOCKS.filter(s => {
    if (query && !s.ticker.toLowerCase().includes(query) && !s.company.toLowerCase().includes(query)) return false;
    if (sectorFilter && s.sector !== sectorFilter) return false;
    if (scoreFilter) {
      const [min, max] = scoreFilter.split('-').map(Number);
      if (s.score < min || s.score > max) return false;
    }
    return true;
  });
}

// ============================================================
// SORTING
// ============================================================
function sortData(data) {
  const col = sortColumn;
  const dir = sortDirection === 'asc' ? 1 : -1;

  return [...data].sort((a, b) => {
    if (col === 'rank') {
      return (b.score - a.score) * dir;
    }

    let aVal = a[col];
    let bVal = b[col];

    // Handle nulls
    if (aVal === null && bVal === null) return 0;
    if (aVal === null) return 1;
    if (bVal === null) return -1;

    if (typeof aVal === 'string') {
      return aVal.localeCompare(bVal) * dir;
    }
    return (aVal - bVal) * dir;
  });
}

// ============================================================
// RENDERING
// ============================================================
function renderTable() {
  const filtered = getFilteredData();
  const sorted = sortData(filtered);
  const tbody = document.getElementById('table-body');
  const emptyState = document.getElementById('empty-state');
  const tableWrapper = document.querySelector('.table-wrapper');

  if (sorted.length === 0) {
    tableWrapper.style.display = 'none';
    emptyState.style.display = 'block';
  } else {
    tableWrapper.style.display = 'block';
    emptyState.style.display = 'none';
  }

  tbody.innerHTML = sorted.map((s, i) => {
    const scoreColor = getScoreColor(s.score);
    const pegColor = getPEGColor(s.peg);
    const fcfColor = getFCFColor(s.fcfYield);
    const divColor = getDivColor(s.divYield);
    const pillClass = sectorClass(s.sector);

    return `<tr>
      <td class="col-rank text-center">${i + 1}</td>
      <td class="col-ticker">${s.ticker}</td>
      <td class="col-company">${s.company}</td>
      <td><span class="sector-pill ${pillClass}">${s.sector}</span></td>
      <td class="col-mcap text-right">${formatMarketCap(s.marketCap)}</td>
      <td class="col-peg text-right" style="color:${pegColor}">${formatPEG(s.peg)}</td>
      <td class="col-fcf text-right" style="color:${fcfColor}">${formatPercent(s.fcfYield)}</td>
      <td class="col-div text-right" style="color:${divColor}">${formatPercent(s.divYield)}</td>
      <td class="text-right">
        <div class="score-cell">
          <span class="score-number" style="color:${scoreColor}">${s.score}</span>
          <div class="score-bar">
            <div class="score-bar-fill" style="width:${s.score}%;background:${scoreColor}"></div>
          </div>
        </div>
      </td>
    </tr>`;
  }).join('');

  updateStats(sorted);
  updateSortHeaders();
}

function updateStats(data) {
  document.getElementById('stat-total').textContent = data.length;

  if (data.length > 0) {
    const avg = data.reduce((sum, s) => sum + s.score, 0) / data.length;
    document.getElementById('stat-avg').textContent = avg.toFixed(1);

    const top = data.reduce((best, s) => s.score > best.score ? s : best, data[0]);
    document.getElementById('stat-top').textContent = top.ticker;
  } else {
    document.getElementById('stat-avg').textContent = '--';
    document.getElementById('stat-top').textContent = '--';
  }

  const now = new Date();
  document.getElementById('stat-date').textContent = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function updateSortHeaders() {
  document.querySelectorAll('.stocks-table th').forEach(th => {
    const col = th.dataset.sort;
    const arrow = th.querySelector('.sort-arrow');
    if (!col || !arrow) return;

    if (col === sortColumn) {
      th.classList.add('sort-active');
      arrow.textContent = sortDirection === 'asc' ? ' \u25B2' : ' \u25BC';
    } else {
      th.classList.remove('sort-active');
      arrow.textContent = ' \u25B2';
    }
  });
}

// ============================================================
// EVENT LISTENERS
// ============================================================

// Sort on header click
document.querySelectorAll('.stocks-table th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.sort;
    if (sortColumn === col) {
      sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      sortColumn = col;
      sortDirection = (col === 'score' || col === 'marketCap' || col === 'fcfYield' || col === 'divYield') ? 'desc' : 'asc';
    }
    renderTable();
  });
});

// Search
let searchTimeout;
document.getElementById('search').addEventListener('input', () => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(renderTable, 150);
});

// Filters
document.getElementById('filter-sector').addEventListener('change', renderTable);
document.getElementById('filter-score').addEventListener('change', renderTable);

// Clear filters
document.getElementById('btn-clear-filters').addEventListener('click', () => {
  document.getElementById('search').value = '';
  document.getElementById('filter-sector').value = '';
  document.getElementById('filter-score').value = '';
  renderTable();
});

// ============================================================
// LAUNCH
// ============================================================
fetchAllData();

</script>
</body>
</html>
